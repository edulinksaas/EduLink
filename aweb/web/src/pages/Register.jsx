import { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import './Register.css';

// í•™ì› ì½”ë“œ ìë™ ìƒì„± í•¨ìˆ˜
// í˜¼ë™í•˜ê¸° ì‰¬ìš´ ë¬¸ì ì œì™¸: 0(ì˜), O(ì˜¤), I(ì•„ì´), 1(ì¼), L(ì—˜)
const generateAcademyCode = () => {
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'; // 0, O, I, 1, L ì œì™¸
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
};

const Register = () => {
  const [formData, setFormData] = useState({
    academy_code: '',
    password: '',
    confirmPassword: '',
    academy_name: '',
    name: '',
    email: '',
    phone: '',
  });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [isCodeAutoGenerated, setIsCodeAutoGenerated] = useState(false);
  const [passwordError, setPasswordError] = useState('');
  const [confirmPasswordError, setConfirmPasswordError] = useState('');
  const { register } = useAuth();
  const navigate = useNavigate();

  // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦ í•¨ìˆ˜
  const validatePassword = (password) => {
    if (password.length < 8) {
      return 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    }
    // ì˜ë¬¸ì(ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)ì™€ ìˆ«ì í¬í•¨ ì—¬ë¶€ í™•ì¸
    if (!/(?=.*[a-zA-Z])/.test(password)) {
      return 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
    }
    if (!/(?=.*\d)/.test(password)) {
      return 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
    }
    return '';
  };

  const handleChange = (e) => {
    const { name, value } = e.target;
    
    // í•™ì› ì´ë¦„ì´ ì…ë ¥ë˜ë©´ í•™ì› ì½”ë“œ ìë™ ìƒì„±
    if (name === 'name' && value.trim() && !isCodeAutoGenerated) {
      const generatedCode = generateAcademyCode();
      setFormData({
        ...formData,
        name: value,
        academy_code: generatedCode,
      });
      setIsCodeAutoGenerated(true);
    } else {
      setFormData({
        ...formData,
        [name]: value,
      });
      
      // í•™ì› ì½”ë“œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•˜ë©´ ìë™ ìƒì„± í”Œë˜ê·¸ í•´ì œ
      if (name === 'academy_code') {
        setIsCodeAutoGenerated(false);
      }
    }
    
    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ê²€ì¦
    if (name === 'password') {
      const validationError = validatePassword(value);
      setPasswordError(validationError);
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ë“œê°€ ì±„ì›Œì ¸ ìˆìœ¼ë©´ ë‹¤ì‹œ í™•ì¸
      if (formData.confirmPassword) {
        if (value !== formData.confirmPassword) {
          setConfirmPasswordError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        } else {
          setConfirmPasswordError('');
        }
      }
    } else if (name === 'confirmPassword') {
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì€ ì¼ì¹˜ ì—¬ë¶€ë§Œ í™•ì¸
      if (value && value !== formData.password) {
        setConfirmPasswordError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      } else {
        setConfirmPasswordError('');
      }
    }
    
    setError('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');

    // ìœ íš¨ì„± ê²€ì¦
    if (!formData.academy_code || !formData.password || !formData.name || !formData.email || !formData.phone) {
      setError('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email.trim())) {
      setError('ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    const passwordValidationError = validatePassword(formData.password);
    if (passwordValidationError) {
      setError(passwordValidationError);
      return;
    }

    if (formData.password !== formData.confirmPassword) {
      setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    setLoading(true);

    try {
      const registerData = {
        academy_code: formData.academy_code.trim(),
        password: formData.password,
        academy_name: formData.name.trim(), // ê´€ë¦¬ì ì´ë¦„ì„ í•™ì› ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
        name: formData.name.trim(),
        email: formData.email.trim(),
        phone: formData.phone.trim(),
      };

      console.log('íšŒì›ê°€ì… ë°ì´í„° ì „ì†¡:', { ...registerData, password: '***' });

      const result = await register(registerData);
      
      console.log('íšŒì›ê°€ì… ê²°ê³¼:', result);
      
      if (result && result.success) {
        // íšŒì›ê°€ì… ì„±ê³µ ì‹œ ì €ì¥ëœ í•™ì› ì½”ë“œë¥¼ ì•Œë ¤ì£¼ê³  ì´ë©”ì¼ ì¸ì¦ ì•ˆë‚´
        const savedAcademyCode = result.user?.academy_code || result.academy_code || formData.academy_code.toUpperCase();
        const emailAddress = formData.email.trim();
        
        alert(
          `íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
          `í•™ì› ì½”ë“œ: ${savedAcademyCode}\n\n` +
          `ì´ë©”ì¼ ì¸ì¦ ë§í¬ë¥¼ ${emailAddress}ë¡œ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.\n` +
          `ì´ë©”ì¼ì„ í™•ì¸í•˜ì—¬ ì¸ì¦ì„ ì™„ë£Œí•œ í›„ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.\n\n` +
          `(ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì½˜ì†”ì— ì¸ì¦ ë§í¬ê°€ ì¶œë ¥ë©ë‹ˆë‹¤)`
        );
        setLoading(false);
        navigate('/login', { replace: true });
      } else {
        // ì—ëŸ¬ ë©”ì‹œì§€ê°€ ê°ì²´ì¸ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
        let errorMsg = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        if (result?.error) {
          if (typeof result.error === 'string') {
            errorMsg = result.error;
          } else if (result.error?.message) {
            errorMsg = result.error.message;
          } else {
            errorMsg = JSON.stringify(result.error);
          }
        }
        console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', errorMsg);
        setError(errorMsg);
        setLoading(false);
      }
    } catch (err) {
      console.error('íšŒì›ê°€ì… ì¤‘ ì˜ˆì™¸ ë°œìƒ:', err);
      const errorMsg = err.message || 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      setError(errorMsg);
      setLoading(false);
    }
  };

  return (
    <div className="auth-page">
      <div className="auth-container register-container">
        <div className="auth-header">
          <h1>í•™ì› ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
          <p>íšŒì›ê°€ì…</p>
        </div>

        <form onSubmit={handleSubmit} className="auth-form">
          {error && <div className="error-message">{error}</div>}

          <div className="form-group">
            <label htmlFor="name">
              í•™ì› ì´ë¦„ <span className="required">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              value={formData.name}
              onChange={handleChange}
              placeholder="í•™ì› ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
              required
              autoFocus
              disabled={loading}
            />
          </div>

          <div className="form-group">
            <label htmlFor="academy_code">
              í•™ì› ì½”ë“œ <span className="required">*</span>
              {isCodeAutoGenerated && (
                <span className="auto-generated-badge">ìë™ ìƒì„±ë¨</span>
              )}
            </label>
            <div className="academy-code-input-wrapper">
              <input
                type="text"
                id="academy_code"
                name="academy_code"
                value={formData.academy_code}
                onChange={handleChange}
                placeholder="í•™ì› ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                required
                disabled={loading}
                style={{ textTransform: 'uppercase' }}
                className={isCodeAutoGenerated ? 'auto-generated' : ''}
              />
              <button
                type="button"
                onClick={() => {
                  const newCode = generateAcademyCode();
                  setFormData({ ...formData, academy_code: newCode });
                  setIsCodeAutoGenerated(true);
                }}
                className="btn-regenerate-code"
                disabled={loading}
                title="ìƒˆ ì½”ë“œ ìƒì„±"
              >
                ğŸ”„
              </button>
            </div>
            <small className="form-hint">
              {isCodeAutoGenerated 
                ? 'ìë™ ìƒì„±ëœ ì½”ë“œì…ë‹ˆë‹¤. í•„ìš”ì‹œ ì¬ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.'
                : 'ì˜ë¬¸ ëŒ€ë¬¸ìì™€ ìˆ«ì ì¡°í•© (ì˜ˆ: ABC12345) - ì¬ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤'}
            </small>
          </div>

          <div className="form-group">
            <label htmlFor="password">
              ë¹„ë°€ë²ˆí˜¸ <span className="required">*</span>
            </label>
            <input
              type="password"
              id="password"
              name="password"
              value={formData.password}
              onChange={handleChange}
              placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 8ì, ì˜ë¬¸ì/ìˆ«ì í¬í•¨)"
              required
              disabled={loading}
            />
            {passwordError && (
              <small className="error-text" style={{ color: '#e74c3c', display: 'block', marginTop: '4px' }}>
                {passwordError}
              </small>
            )}
            {!passwordError && formData.password && (
              <small className="success-text" style={{ color: '#27ae60', display: 'block', marginTop: '4px' }}>
                âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•©ë‹ˆë‹¤.
              </small>
            )}
          </div>

          <div className="form-group">
            <label htmlFor="confirmPassword">
              ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span className="required">*</span>
            </label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              value={formData.confirmPassword}
              onChange={handleChange}
              placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
              required
              disabled={loading}
            />
            {confirmPasswordError && (
              <small className="error-text" style={{ color: '#e74c3c', display: 'block', marginTop: '4px' }}>
                {confirmPasswordError}
              </small>
            )}
            {!confirmPasswordError && formData.confirmPassword && formData.password === formData.confirmPassword && (
              <small className="success-text" style={{ color: '#27ae60', display: 'block', marginTop: '4px' }}>
                âœ“ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.
              </small>
            )}
          </div>

          <div className="form-group">
            <label htmlFor="email">
              ì´ë©”ì¼ <span className="required">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              value={formData.email}
              onChange={handleChange}
              placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
              disabled={loading}
            />
          </div>

          <div className="form-group">
            <label htmlFor="phone">
              ì—°ë½ì²˜ <span className="required">*</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              value={formData.phone}
              onChange={handleChange}
              placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 010-1234-5678)"
              required
              disabled={loading}
            />
          </div>

          <button type="submit" className="btn-primary" disabled={loading}>
            {loading ? 'ê°€ì… ì¤‘...' : 'íšŒì›ê°€ì…'}
          </button>
        </form>

        <div className="auth-footer">
          <p>
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?{' '}
            <Link to="/login">ë¡œê·¸ì¸</Link>
          </p>
        </div>
      </div>
    </div>
  );
};

export default Register;

